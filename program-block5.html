<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>源视</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <style>
        /* 原有样式保持不变 */
        body { margin: 0; padding: 0; background-color: #0f1c3c; color: #fff; font-family: "Microsoft YaHei", sans-serif; }
        .dashboard { width: 100%; height: 100vh; padding: 20px; box-sizing: border-box; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: 80px 1fr 1fr; gap: 15px; }
        .header { grid-column: 1 / 4; display: flex; justify-content: center; align-items: center; background: linear-gradient(90deg, rgba(16,42,87,0.5) 0%, rgba(36,92,187,0.5) 50%, rgba(16,42,87,0.5) 100%); border-radius: 10px; box-shadow: 0 0 20px rgba(0,150,255,0.3); }
        .header h1 { font-size: 32px; letter-spacing: 2px; text-shadow: 0 0 10px rgba(0,150,255,0.7); }
        .chart-container { background-color: rgba(16, 42, 87, 0.7); border-radius: 10px; padding: 15px; box-shadow: 0 0 15px rgba(0, 100, 200, 0.2); display: flex; flex-direction: column; }
        .chart-title { font-size: 16px; margin-bottom: 10px; color: #7fdbff; text-align: center; }
        .chart { flex: 1; width: 100%; }
        .chart-large { grid-row: span 2; }
        
        .heatmap-tooltip {
            background: rgba(16,42,87,0.9) !important;
            border: 1px solid #1a5bbf !important;
            color: #fff !important;
        }

        /* 添加激活状态样式 */
        .repo-btn.active {
            background: rgba(36,92,187,0.7);
            box-shadow: 0 0 10px rgba(0,150,255,0.5);
        }

        /* 新增表格样式 */
        .rank-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: rgba(16, 42, 87, 0.5);
        }

        .rank-table th, .rank-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(127, 219, 255, 0.1);
        }

        .rank-table th {
            background: rgba(36, 92, 187, 0.3);
            color: #7fdbff;
            font-weight: normal;
        }

        .rank-table tbody tr:hover {
            background: rgba(36, 92, 187, 0.2);
        }

        .sortable {
            cursor: pointer;
            transition: all 0.3s;
        }

        .sortable:hover {
            background: rgba(36, 92, 187, 0.5);
        }

        /* 调整表格列宽 */
        .rank-table td:nth-child(4) {
            min-width: 100px;
            text-align: center;
        }
        
        /* 新增颜色样式 */
        span[style*="00ff88"] {
            font-weight: bold;
            text-shadow: 0 0 8px rgba(0,255,136,0.4);
        }

        /* 进度条样式 */
        .progress-bar {
            position: relative;
            height: 24px;
            background: rgba(16, 42, 87, 0.5);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: linear-gradient(90deg, #3a4de9, #1a5bbf);
            transition: width 0.5s ease;
        }

        .progress-bar span {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255,255,255,0.8);
            font-size: 12px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        /*悬浮球css*/
        #floatBall {
            position: fixed;
            top: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background-color: #1a5bbf;
            color: #fff;
            font-size: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0, 150, 255, 0.4);
            cursor: pointer;
            z-index: 9999;
            transition: all 0.3s ease;
        }
        #floatBall:hover {
            background-color: #00aaff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.6);
        }
        /* 自定义悬浮球提示词 */
        #floatBall::after {
            content: "🧠小源分析";
            white-space: nowrap; /*换行 */
            position: absolute;
            top: 60px;
            right: 0;
            background-color: rgba(16, 42, 87, 0.95);
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 10000;
        }

        #floatBall:hover::after {
            opacity: 1;
        }
        /*截图框样式*/
        #screenshotSelection {
            position: absolute;
            border: 2px dashed #00aaff;
            background-color: rgba(0, 170, 255, 0.1);
            pointer-events: none;
            display: none;
            z-index: 9998;
        }
        /*图片预览区*/
        #screenshotPreview {
            position: fixed;
            bottom: 80px;
            right: 30px;
            max-width: 300px;
            border: 1px solid #ccc;
            z-index: 9999;
            display: none;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header"><h1>源视</h1></div>
        <!-- 修改为表格形式 -->
        <div class="chart-container">
            <div class="chart-title">仓库OpenRank值排行</div>
            <div id="activityTable" class="chart">
                <table class="rank-table">
                    <thead>
                        <tr>
                            <th>排名</th>
                            <th>仓库</th>
                            <th class="sortable" onclick="sortTable('openrank')">OPENRANK ▼</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
        <div class="chart-container chart-large"><div class="chart-title">Top5仓库星标数(Star)趋势对比</div><div id="starTrendChart" class="chart"></div></div>
        <div class="chart-container"><div class="chart-title">Top5仓库响应时间(issue_response_time)动态排序</div><div id="responseTimeChart" class="chart"></div></div>
        <div class="chart-container chart-large">
            <div class="chart-title">
                Top5仓库活跃度(activity)热力图
                <div class="repo-switcher" style="margin-top: 10px;">
                    <button class="repo-btn active" onclick="updateHeatmap('microsoft/vscode')">vscode</button>
                    <button class="repo-btn" onclick="updateHeatmap('pytorch/pytorch')">pytorch</button>
                    <button class="repo-btn" onclick="updateHeatmap('NixOS/nixpkgs')">nixpkgs</button>
                    <button class="repo-btn" onclick="updateHeatmap('llvm/llvm-project')">llvm</button>
                </div>
            </div>
            <div id="heatmapChart" class="chart"></div>
        </div>
        <div class="chart-container">
            <div class="chart-title">
                2024年度Top5仓库健康度评估
                <div class="repo-switcher" style="margin-top: 10px;">
                    <button class="repo-btn" onclick="updateHealthChart('microsoft/vscode')">vscode</button>
                    <button class="repo-btn" onclick="updateHealthChart('pytorch/pytorch')">pytorch</button>
                    <button class="repo-btn" onclick="updateHealthChart('NixOS/nixpkgs')">nixpkgs</button>
                    <button class="repo-btn" onclick="updateHealthChart('llvm/llvm-project')">llvm</button>
                </div>
            </div>
            <div id="healthChart" class="chart"></div>
        </div>
    </div>

    <style>
        /* 添加按钮样式 */
        .repo-btn {
            margin: 0 5px;
            padding: 4px 12px;
            background: rgba(36,92,187,0.3);
            border: 1px solid #1a5bbf;
            color: #7fdbff;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .repo-btn:hover {
            background: rgba(36,92,187,0.5);
            box-shadow: 0 0 8px rgba(0,150,255,0.3);
        }
        </style>
        
    <script>
        // 初始化所有图表
        const responseTimeChart = echarts.init(document.getElementById('responseTimeChart'));
        const starTrendChart = echarts.init(document.getElementById('starTrendChart'));
        const heatmapChart = echarts.init(document.getElementById('heatmapChart'));
        const healthChart = echarts.init(document.getElementById('healthChart'));

        // 通用数据过滤函数
        const filterMonthlyData = (data) => {
            return Object.entries(data).reduce((acc, [key, value]) => {
                if (/\d{4}-\d{2}$/.test(key) && !key.includes('Q')) {
                    acc[key] = value;
                }
                return acc;
            }, {});
        };

        // ==================== 仓库排行表格 ====================
        let currentData = [];
        let sortKey = 'openrank';
        let isAsc = false;

        async function initActivityData() {
            try {
                const response = await fetch('openrank_yearly_2024.csv');
                if (!response.ok) throw new Error('文件加载失败');
                
                const csvText = await response.text();
                const rows = csvText.split('\n').slice(1); // 跳过标题行
                
                currentData = rows
                    .filter(row => row.trim()) // 过滤空行
                    .map(row => {
                        const [repo_name, year, openrank] = row.split(',');
                        return {
                            name: repo_name,
                            openrank: parseFloat(openrank)
                        };
                    })
                    .filter(item => !isNaN(item.openrank)) // 过滤无效数据
                    .sort((a, b) => b.openrank - a.openrank)
                    .slice(0, 10); // 取前10名

                updateTable();
            } catch (error) {
                console.error('数据加载失败:', error);
                document.getElementById('tableBody').innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align:center;color:#ff4d4f;">
                            数据加载失败，请检查CSV文件路径
                        </td>
                    </tr>`;
            }
        }

        function updateTable() {
            const sortedData = currentData.sort((a, b) => 
                isAsc ? a[sortKey] - b[sortKey] : b[sortKey] - a[sortKey]
            );

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = sortedData.map((item, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>
                        <a href="https://github.com/${item.name}" 
                        target="_blank"
                        style="color:#7fdbff;text-decoration:none;">
                            ${item.name}
                        </a>
                    </td>
                    <td>${item.openrank.toLocaleString(undefined, { maximumFractionDigits: 2 })}</td>
                </tr>`
            ).join('');

            // 更新排序指示
            document.querySelectorAll('.sortable').forEach(th => {
                th.innerHTML = th.innerHTML.replace('▼','').replace('▲','');
                if(th.getAttribute('onclick').includes(sortKey)) {
                    th.innerHTML += isAsc ? ' ▲' : ' ▼';
                }
            });
        }

        function sortTable(key) {
            if(sortKey === key) {
                isAsc = !isAsc;
            } else {
                sortKey = key;
                isAsc = false;
            }
            updateTable();
        }

        // ==================== 仓库响应时间动态排序图 ====================
        const repoColors = {
            "microsoft/vscode": "#007ACC",
            "pytorch/pytorch": "#EE4C2C",
            "NixOS/nixpkgs": "#5277C3",
            "llvm/llvm-project": "#259B24"
        };

        const responseTimeOption = {
            grid: {
                top: 10,
                bottom: 30,
                left: 150,
                right: 80
            },
            xAxis: {
                max: 'dataMax',
                axisLabel: {
                    formatter: n => Math.round(n) + 'h',
                    color: '#8f9bb3'
                },
                axisLine: {
                    lineStyle: {
                        color: '#3a465e'
                    }
                },
                splitLine: {
                    lineStyle: {
                        color: 'rgba(58,70,94,0.5)'
                    }
                }
            },
            yAxis: {
                type: 'category',
                inverse: true,
                max: 3, // 修改max值显示四个条目
                axisLabel: {
                    fontSize: 14,
                    color: '#8f9bb3'
                },
                animationDuration: 300,
                animationDurationUpdate: 300,
                axisLine: {
                    lineStyle: {
                        color: '#3a465e'
                    }
                }
            },
            series: [{
                id: 'bar',
                type: 'bar',
                realtimeSort: true,
                barWidth: 40, // 调小柱宽
                itemStyle: {
                    color: param => repoColors[param.name] || '#5470c6',
                    borderRadius: [0, 4, 4, 0]
                },
                label: {
                    show: true,
                    position: 'right',
                    formatter: '{@value}h',
                    valueAnimation: true,
                    color: '#fff'
                },
                encode: { x: 'value', y: 'repo' },
                data: []
            }],
            animationDuration: 0,
            animationDurationUpdate: 1500,
            animationEasing: 'linear',
            animationEasingUpdate: 'linear',
            graphic: {
                elements: [{
                    type: 'text',
                    right: 30,
                    bottom: 60,
                    style: {
                        text: '',
                        font: 'bolder 80px monospace',
                        fill: 'rgba(127, 219, 255, 0.3)'
                    },
                    z: 100
                }]
            }
        };

        // 更新图表函数
        function updateChart(date) {
            // 确保所有仓库都有数据
            const currentData = Object.keys(fullData)
                .map(repo => ({
                    name: repo,
                    value: fullData[repo].avg[date] || 0
                }))
                .sort((a, b) => b.value - a.value);

            // 强制显示四个仓库
            responseTimeOption.yAxis.data = currentData.map(item => item.name).slice(0,4);
            responseTimeOption.series[0].data = currentData.slice(0,4); // 取前四个
            responseTimeOption.graphic.elements[0].style.text = date;

            responseTimeChart.setOption(responseTimeOption, true);
        }

        let fullData = {}; // 用于存储响应时间数据

        async function initResponseTimeData() {
            try {
                const responses = await Promise.all([
                    fetch('https://oss.open-digger.cn/github/microsoft/vscode/issue_resolution_duration.json'),
                    fetch('https://oss.open-digger.cn/github/pytorch/pytorch/issue_resolution_duration.json'),
                    fetch('https://oss.open-digger.cn/github/NixOS/nixpkgs/issue_resolution_duration.json'),
                    fetch('https://oss.open-digger.cn/github/llvm/llvm-project/issue_resolution_duration.json')
                ]);

                // 修正变量解构
                const [vscodeData, pytorchData, nixpkgsData, llvmData] = await Promise.all(responses.map(r => r.json()));

                // 修正数据引用
                fullData = {
                    "microsoft/vscode": { avg: filterMonthlyData(vscodeData.avg) },
                    "pytorch/pytorch": { avg: filterMonthlyData(pytorchData.avg) },
                    "NixOS/nixpkgs": { avg: filterMonthlyData(nixpkgsData.avg) },
                    "llvm/llvm-project": { avg: filterMonthlyData(llvmData.avg) }
                };

                // 保持后续逻辑不变
                const allDates = [...new Set(Object.values(fullData).flatMap(repo => Object.keys(repo.avg)))].sort();

                // 自动播放逻辑
                let currentIndex = 0;
                const timer = setInterval(() => {
                    currentIndex = (currentIndex + 1) % allDates.length;
                    updateChart(allDates[currentIndex]);
                }, 1500);

                updateChart(allDates[0]);
            } catch (error) {
                console.error('响应时间数据加载失败:', error);
                responseTimeChart.setOption({
                    graphic: {
                        elements: [{
                            type: 'text',
                            left: 'center',
                            top: 'middle',
                            style: {
                                text: '数据加载失败',
                                fontSize: 24,
                                fill: '#ff4d4f'
                            }
                        }]
                    }
                });
            }
        }

        // ==================== Star趋势图表 ====================
        const starTrendOption = {
            tooltip: { 
                trigger: 'axis',
                backgroundColor: 'rgba(16,42,87,0.9)',
                borderColor: '#1a5bbf',
                textStyle: { color: '#fff' },
                axisPointer: {
                    type: 'cross',
                    label: {
                        backgroundColor: '#6a7985'
                    }
                }
            },
            legend: { 
                top: 10,
                textStyle: { color: '#ccc' },
                itemWidth: 12,
                itemHeight: 8,
                selectedMode: 'single'
            },
            grid: { 
                left: '3%', 
                right: '4%', 
                bottom: '15%',
                containLabel: true 
            },
            dataZoom: [
                {
                    type: 'slider',
                    show: true,
                    xAxisIndex: [0],
                    start: 70,
                    end: 100,
                    height: 20,
                    bottom: 20,
                    borderColor: 'transparent',
                    backgroundColor: 'rgba(16,42,87,0.7)',
                    fillerColor: 'rgba(36,92,187,0.5)',
                    handleIcon: 'M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.3v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z',
                    handleSize: '80%',
                    handleStyle: {
                        color: '#1a5bbf',
                        borderColor: '#7fdbff'
                    },
                    textStyle: {
                        color: '#7fdbff'
                    }
                },
                {
                    type: 'inside',
                    xAxisIndex: [0],
                    zoomOnMouseWheel: true,
                    moveOnMouseMove: true,
                    moveOnMouseWheel: false
                }
            ],
            xAxis: {
                type: 'category',
                data: [],
                axisLabel: { 
                    rotate: 45,
                    color: '#8f9bb3',
                    fontSize: 12
                },
                axisLine: { 
                    lineStyle: { 
                        color: '#3a465e' 
                    } 
                },
                axisTick: { show: false }
            },
            yAxis: {
                type: 'value',
                axisLine: { 
                    lineStyle: { 
                        color: '#3a465e' 
                    } 
                },
                splitLine: { 
                    lineStyle: { 
                        color: 'rgba(58,70,94,0.5)' 
                    } 
                },
                axisLabel: { color: '#8f9bb3' }
            },
            series: []
        };

        async function initStarTrendData() {
            try {
                const responses = await Promise.all([
                    fetch('https://oss.open-digger.cn/github/microsoft/vscode/stars.json'),
                    fetch('https://oss.open-digger.cn/github/pytorch/pytorch/stars.json'),
                    fetch('https://oss.open-digger.cn/github/NixOS/nixpkgs/stars.json'),
                    fetch('https://oss.open-digger.cn/github/llvm/llvm-project/stars.json')
                ]);

                // 获取所有仓库数据
                const [vscodeData, pytorchData, nixpkgsData, llvmData] = await Promise.all(responses.map(r => r.json()));

                // 修正数据转换逻辑
                const convertData = (rawData, repoName) => {
                    const filtered = filterMonthlyData(rawData);
                    return Object.entries(filtered).map(([Year, Income]) => ({
                        Year,
                        Country: repoName,
                        Income
                    }));
                };

                // 使用正确的数据变量
                const allStarData = [
                    ...convertData(vscodeData, 'microsoft/vscode'),
                    ...convertData(pytorchData, 'pytorch/pytorch'),
                    ...convertData(nixpkgsData, 'NixOS/nixpkgs'),
                    ...convertData(llvmData, 'llvm/llvm-project')
                ];

                // 生成x轴数据
                const xAxisData = [...new Set(allStarData.map(d => d.Year))].sort();
                const repoList = [...new Set(allStarData.map(d => d.Country))];

                // 更新系列颜色配置
                starTrendOption.series = repoList.map((repo, idx) => ({
                    name: repo,
                    type: 'line',
                    smooth: true,
                    showSymbol: false,
                    lineStyle: { 
                        width: 2,
                        color: repoColors[repo] // 使用仓库标准颜色
                    },
                    areaStyle: {
                        opacity: 0.15,
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: repoColors[repo] + 'CC' }, // 添加透明度
                            { offset: 1, color: repoColors[repo] + '00' }
                        ])
                    },
                    data: xAxisData.map(year => {
                        const item = allStarData.find(d => d.Year === year && d.Country === repo);
                        return item ? item.Income : null;
                    }),
                    emphasis: {
                        lineStyle: { width: 3 }
                    }
                }));

                starTrendOption.xAxis.data = xAxisData;
                starTrendChart.setOption(starTrendOption);

            } catch (error) {
                console.error('Star数据加载失败:', error);
                starTrendChart.setOption({
                    graphic: {
                        elements: [{
                            type: 'text',
                            left: 'center',
                            top: 'middle',
                            style: {
                                text: '数据加载失败',
                                fontSize: 24,
                                fill: '#ff4d4f'
                            }
                        }]
                    }
                });
            }
        }

        // 热力图配置选项
        let heatmapOption = {
            title: {
                text: '',
                left: 'center',
                textStyle: {
                    color: '#7fdbff',
                    fontSize: 16
                }
            },
            tooltip: {
                formatter: function(params) {
                    return `${params.value[0]}年${params.value[1]}月<br>活跃度: ${params.value[2]}`;
                },
                className: 'heatmap-tooltip'
            },
            grid: {
                top: 70,
                bottom: 30,
                left: 60,
                right: 30
            },
            xAxis: {
                type: 'category',
                data: [],
                axisLabel: {
                    color: '#8f9bb3'
                }
            },
            yAxis: {
                type: 'category',
                data: ['01','02','03','04','05','06','07','08','09','10','11','12'],
                axisLabel: {
                    color: '#8f9bb3'
                }
            },
            visualMap: {
                min: 0,
                max: 100,
                calculable: true,
                orient: 'vertical',
                right: 10,
                top: 20,
                inRange: {
        color: [
            '#1a5bbf',   // 最低值颜色
            '#3a8cff',   // 25%位置
            '#00d4ff',   // 50%位置
            '#a0ff3c',   // 75%位置
            '#ffd000',   // 90%位置
            '#ff2a2a'    // 最高值颜色
        ],
        // 自定义颜色分布位置（可选）
        colorStops: [
            { offset: 0, color: '#1a5bbf' },
            { offset: 0.25, color: '#3a8cff' },
            { offset: 0.5, color: '#00d4ff' },
            { offset: 0.75, color: '#a0ff3c' },
            { offset: 0.9, color: '#ffd000' },
            { offset: 1, color: '#ff2a2a' }
        ]
    },
                textStyle: {
                    color: '#fff'
                }
            },
            series: [{
                type: 'heatmap',
                data: [],
                label: {
                    show: false
                },
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }]
        };



        // 热力图数据获取函数
        async function updateHeatmap(repo) {
            try {
                heatmapChart.showLoading();
                
                // 获取数据
                const response = await fetch(`https://oss.open-digger.cn/github/${repo}/activity.json`);
                const rawData = await response.json();
                
                // 过滤2020年及以后的数据
                const filteredData = filterMonthlyData(rawData);
                const data = Object.entries(filteredData)
                    .filter(([date]) => parseInt(date.split('-')[0]) >= 2020)
                    .map(([date, value]) => {
                        const [year, month] = date.split('-');
                        return [year, month, value || 0];
                    });

                // 动态计算最大值
                const maxValue = Math.max(...data.map(item => item[2]));
                heatmapOption.visualMap.max = maxValue;

                // 生成x轴数据（年份）
                const years = [...new Set(data.map(item => item[0]))].sort();
                heatmapOption.xAxis.data = years;

                // 转换数据格式
                heatmapOption.series[0].data = data.map(item => [
                    item[0], // x轴：年份
                    item[1], // y轴：月份
                    item[2] // 值
                ]);

                // 更新标题
                heatmapOption.title.text = `当前仓库：${repo}`;

                heatmapChart.setOption(heatmapOption);
                heatmapChart.hideLoading();

                // 更新按钮激活状态
                document.querySelectorAll('.repo-switcher .repo-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.textContent === repo.split('/')[1]);
                });

            } catch (error) {
                console.error('热力图数据加载失败:', error);
                heatmapChart.setOption({
                    graphic: {
                        elements: [{
                            type: 'text',
                            left: 'center',
                            top: 'middle',
                            style: {
                                text: '数据加载失败',
                                fontSize: 24,
                                fill: '#ff4d4f'
                            }
                        }]
                    }
                });
            }
        }
        
        // 初始化时加载默认数据
        updateHeatmap('microsoft/vscode');

        // ==================== 健康度评估配置 ====================
        const healthOption = {
    title: {  // 新增标题配置
        text: '当前仓库：',
        left: 'center',
        textStyle: {
            color: '#7fdbff',
            fontSize: 16,
            textShadow: '0 0 10px rgba(0,150,255,0.3)'
        },
        top: 10  // 调整标题位置
    },
    tooltip: { trigger: 'item' },
    radar: {
        indicator: [
            { name: '技术分叉均值', max: 500 },
            { name: '新问题均值', max: 2000 },
            { name: '关注度均值', max: 5000 },
            { name: '问题解决时间均值', max: 50 },
            { name: '新贡献者均值', max: 200 },
            { name: '变更请求均值', max: 7000 }
        ],
        radius: '60%',  // 减小半径给标题留空间
        center: ['50%', '55%'],  // 调整雷达图位置
        axisName: { color: '#7fdbff' },
        splitArea: { areaStyle: { color: ['rgba(16, 42, 87, 0.5)', 'rgba(16, 42, 87, 0.3)'] } },
        axisLine: { lineStyle: { color: 'rgba(100, 100, 100, 0.2)' } },
        splitLine: { lineStyle: { color: 'rgba(100, 100, 100, 0.2)' } }
    },
    series: [{
        type: 'radar',
        data: [{
            value: [],
            name: '健康度评估',
            areaStyle: { color: 'rgba(58, 77, 233, 0.4)' },
            lineStyle: { width: 2, color: '#3a4de9' },
            symbolSize: 6
        }]
    }],
    color: ['#3a4de9']
};

// 新增健康度数据获取函数
async function updateHealthChart(repo) {
    try {
        healthChart.showLoading();
        
        // 更新标题
        healthOption.title.text = `当前仓库：${repo}`;
        healthChart.setOption(healthOption);  // 先更新标题

        // 更新按钮状态
        document.querySelectorAll('#healthChart + .chart-title .repo-btn').forEach(btn => {
            btn.classList.toggle('active', btn.textContent === repo.split('/')[1]);
        });

        // 动态构建请求URL
        const [openrankRes, activityRes, starsRes, issueRes, contributorsRes, prRes] = await Promise.all([
            fetch(`https://oss.open-digger.cn/github/${repo}/technical_fork.json`),
            fetch(`https://oss.open-digger.cn/github/${repo}/issues_new.json`),
            fetch(`https://oss.open-digger.cn/github/${repo}/attention.json`),
            fetch(`https://oss.open-digger.cn/github/${repo}/issue_resolution_duration.json`),
            fetch(`https://oss.open-digger.cn/github/${repo}/new_contributors.json`),
            fetch(`https://oss.open-digger.cn/github/${repo}/change_requests.json`)
        ]);

        // 数据处理
        const processData = (data, isIssueData = false) => {
            const filtered = filterMonthlyData(isIssueData ? data.avg : data);
            return Object.entries(filtered)
                .filter(([key]) => key.startsWith('2024'))
                .map(([date, val]) => val); // 显式取值
        };

        // 计算平均值（确保数值类型）
        const calcMean = arr => {
            if(!arr.length) return 0;
            const sum = arr.reduce((a,b) => a + Number(b), 0);
            return parseFloat((sum / arr.length).toFixed(2));
        }

        // 各指标计算
        const openrankValues = processData(await openrankRes.json());
        const activityValues = processData(await activityRes.json());
        const starsValues = processData(await starsRes.json());
        const issueValues = processData(await issueRes.json(), true);
        const contributorsValues = processData(await contributorsRes.json());
        const prValues = processData(await prRes.json());

        // 更新雷达图数据
        healthOption.series[0].data[0].value = [
            calcMean(openrankValues),
            calcMean(activityValues),
            calcMean(starsValues),
            calcMean(issueValues),
            calcMean(contributorsValues),
            calcMean(prValues)
        ];

        healthChart.setOption(healthOption, true);
        healthChart.hideLoading();
    } catch (error) {
        console.error('健康度数据加载失败:', error);
        healthChart.setOption({
            graphic: {
                elements: [{
                    type: 'text',
                    left: 'center',
                    top: 'middle',
                    style: {
                        text: '数据加载失败',
                        fontSize: 24,
                        fill: '#ff4d4f'
                    }
                }]
            }
        });
    }
}
        // 初始化时加载默认仓库
        document.querySelectorAll('.repo-btn').forEach(btn => {
    if(btn.textContent !== 'vscode') btn.disabled = true; // 只允许点击默认按钮
});
        updateHealthChart('microsoft/vscode');

        // ==================== 初始化所有图表 ====================
        async function initAllCharts() {
            // 显示加载状态
            [responseTimeChart, starTrendChart].forEach(chart => 
                chart.showLoading('default', {
                    text: '加载中...',
                    color: '#7fdbff',
                    textColor: '#fff'
                })
            );

            try {
                await Promise.all([
                    initResponseTimeData(), 
                    initStarTrendData(),
                    initActivityData() // 初始化表格数据
                ]);
            } finally {
                // 隐藏加载状态
                [responseTimeChart, starTrendChart].forEach(chart => 
                    chart.hideLoading()
                );
                document.querySelectorAll('.repo-btn').forEach(btn => btn.disabled = false);
            }

                document.querySelectorAll('.repo-btn').forEach(btn => btn.disabled = false);
        }

        // 启动初始化
        initAllCharts();

        // 响应式调整
        window.addEventListener('resize', () => {
            [responseTimeChart, starTrendChart, commitChart, healthChart,heatmapChart]
                .forEach(chart => chart.resize());
        });

        //悬浮球点击事件
        window.addEventListener('DOMContentLoaded', () => {
            const ball = document.getElementById('floatBall');
            let isDragging = false;
            let startX, startY;
            let dragThreshold = 5; // 拖动与点击的判定临界距离
            let clickTimer = null;

            ball.addEventListener('mousedown', (e) => {
                e.preventDefault();
                isDragging = false;
                startX = e.clientX;
                startY = e.clientY;

                // 定义移动时行为
                const onMouseMove = (moveEvent) => {
                    const dx = moveEvent.clientX - startX;
                    const dy = moveEvent.clientY - startY;

                    if (Math.abs(dx) > dragThreshold || Math.abs(dy) > dragThreshold) {
                        isDragging = true;
                    }

                    if (isDragging) {
                        ball.style.left = moveEvent.clientX - 30 + 'px';
                        ball.style.top = moveEvent.clientY - 30 + 'px';
                        ball.style.right = 'auto';
                        ball.style.bottom = 'auto';
                    }
                };

                // 鼠标松开
                const onMouseUp = (upEvent) => {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);

                    if (isDragging) {
                        // 自动吸附到最近的边
                        const windowWidth = window.innerWidth;
                        const finalX = upEvent.clientX;
                        if (finalX < windowWidth / 2) {
                            // 靠左吸附
                            ball.style.left = '10px';
                            ball.style.right = 'auto';
                        } else {
                            // 靠右吸附
                            ball.style.right = '10px';
                            ball.style.left = 'auto';
                        }
                    } else {
                        // 如果没拖动 → 视为点击 → 弹出截图框
                        activateScreenshot();
                    }
                };

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });

            // 弹出提示词函数（简洁淡入淡出）
            function showTooltip(target, text) {
                const tooltip = document.createElement('div');
                tooltip.innerText = text;
                tooltip.style.position = 'fixed';
                tooltip.style.top = target.getBoundingClientRect().top + 70 + 'px';
                tooltip.style.left = target.getBoundingClientRect().left + 'px';
                tooltip.style.backgroundColor = '#1a5bbf';
                tooltip.style.color = '#fff';
                tooltip.style.padding = '6px 12px';
                tooltip.style.borderRadius = '8px';
                tooltip.style.boxShadow = '0 0 10px rgba(0,0,0,0.2)';
                tooltip.style.zIndex = 9999;
                tooltip.style.transition = 'opacity 0.5s ease';
                tooltip.style.opacity = 0;

                document.body.appendChild(tooltip);
                requestAnimationFrame(() => {
                    tooltip.style.opacity = 1;
                });

                setTimeout(() => {
                    tooltip.style.opacity = 0;
                    setTimeout(() => tooltip.remove(), 500);
                }, 1800);
            }
        });

        //截图功能
        function activateScreenshot() {
            let startX, startY, endX, endY;
            const selection = document.getElementById('screenshotSelection');
            const preview = document.getElementById('screenshotPreview');
            const resultBox = document.getElementById('screenshotResult');
            const resultText = document.getElementById('analysisResult');

            document.body.style.cursor = 'crosshair';

            const onMouseDown = (e) => {
                startX = e.clientX;
                startY = e.clientY;
                selection.style.left = startX + 'px';
                selection.style.top = startY + 'px';
                selection.style.width = '0px';
                selection.style.height = '0px';
                selection.style.display = 'block';

                const onMouseMove = (moveEvent) => {
                    endX = moveEvent.clientX;
                    endY = moveEvent.clientY;

                    const rectX = Math.min(startX, endX);
                    const rectY = Math.min(startY, endY);
                    const width = Math.abs(endX - startX);
                    const height = Math.abs(endY - startY);

                    selection.style.left = rectX + 'px';
                    selection.style.top = rectY + 'px';
                    selection.style.width = width + 'px';
                    selection.style.height = height + 'px';
                };

                const onMouseUp = () => {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                    selection.style.display = 'none';
                    document.body.style.cursor = 'default';

                    html2canvas(document.body, {
                        x: Math.min(startX, endX),
                        y: Math.min(startY, endY),
                        width: Math.abs(endX - startX),
                        height: Math.abs(endY - startY),
                        windowWidth: document.documentElement.scrollWidth,
                        windowHeight: document.documentElement.scrollHeight
                    }).then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        preview.src = imgData;
                        resultBox.style.display = 'block';

                        // 上传给后端
                        const base64Data = imgData.split(',')[1];
                        fetch('http://localhost:8000/upload', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ image_data: base64Data })
                        })
                        .then(res => res.json())
                        .then(data => {
                            console.log("后端返回：",data);
                            resultText.innerText = data.result || "✅ 后端分析成功，但无具体内容返回。";
                        })
                        .catch(err => {
                            resultText.innerText = "❌ 上传或分析失败：" + err;
                        });
                    });
                };

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            };

            document.addEventListener('mousedown', onMouseDown, { once: true });
        }

        function closeResult() {
            document.getElementById('screenshotResult').style.display = 'none';
        }
    </script>

    <!--悬浮球 -->
    <div id="floatBall" title="智能分析">🧠</div>
    <!--截图框-->
    <div id="screenshotSelection"></div>
    <!-- 截图预览 + 文本返回展示框 -->
    <div id="screenshotResult"
         style="display:none;
         position: fixed;
         bottom: 30px;
         right: 30px;
         width: 320px;
         background: #fff;
         border: 1px solid #ccc;
         padding: 10px;
         z-index: 9999;
         box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
      <img id="screenshotPreview" style="max-width: 100%;" />
      <p id="analysisResult" style="margin-top: 10px;
          font-size: 14px;
          line-height: 1.4;
          color: #333;">
      </p>
      <button onclick="closeResult()" style="margin-top: 10px;
            padding: 4px 10px;">关闭</button>
    </div>
</body>
</html>